Page({data:{notifications:[],showMainInput:true,mainInputValue:'',mainInputFocus:false,dynamicPlaceholder:'æƒ³åƒå¥½æ¶ˆåŒ–çš„',placeholderIndex:0,autoDetectedTime:'',autoBudget:20,showWorkingIndicator:false,workingText:'æ­£åœ¨ä¸ºæ‚¨æŒ‘é€‰å¤–å–...',showQuickHints:false,showRippleEffect:false,countdownActive:false,countdownSeconds:5,countdownTimer:null,userData:{mealTime:'',budget:20,preferences:'',location:''},isProcessing:false,hasResult:false,notificationId:0,scrollTop:0,scrollIntoView:''},onLoad(){this.initSys();this.startPlh();this.autoDetCtx();},onUnload(){if(this.data.countdownTimer)clearInterval(this.data.countdownTimer);if(this.placeholderTimer)clearInterval(this.placeholderTimer);},initSys(){console.log('é€æ˜ç®¡å®¶ç³»ç»Ÿå¯åŠ¨...');},startPlh(){const p=['æƒ³åƒå¥½æ¶ˆåŒ–çš„','ä»Šå¤©æ™šä¸Šæˆ‘è¦åƒ20å…ƒçš„ç‚¸é¸¡','ä»Šå¤©ä¸­åˆç‚¹ä¸€ä¸ªå°äº15å…ƒçš„å¿«é¤'];this.placeholderTimer=setInterval(()=>{const c=this.data.placeholderIndex;const n=(c+1)%p.length;this.setData({dynamicPlaceholder:p[n],placeholderIndex:n});},4000);},autoDetCtx(){const n=new Date();const h=n.getHours();let t='';let b=20;if(h>=11&&h<=14){t='é»˜è®¤ï¼šç«‹å³ä¸‹å•';b=20;}else if(h>=17&&h<=21){t='é»˜è®¤ï¼šç«‹å³ä¸‹å•';b=20;}else if(h>=21||h<=2){t='é»˜è®¤ï¼šç«‹å³ä¸‹å•';b=20;}else{t='é»˜è®¤ï¼šç«‹å³ä¸‹å•';}this.setData({autoDetectedTime:t,autoBudget:b,['userData.mealTime']:t,['userData.budget']:b});},showWorkingStatus(t='æ­£åœ¨ä¸ºæ‚¨æŒ‘é€‰å¤–å–...'){this.setData({showWorkingIndicator:true,workingText:t,isProcessing:true});this.scrBot();},hideWorkingStatus(){this.setData({showWorkingIndicator:false,isProcessing:false});},

addNotification(c,t='notification',o={}){const n=this.data.notificationId+1;const ntf={id:n,type:t,content:c,timestamp:Date.now(),...o};this.setData({notifications:[...this.data.notifications,ntf],notificationId:n,scrollIntoView:`notification-${n}`});this.scrBot();},addUserEcho(c){const n=this.data.notificationId+1;const ntf={id:n,type:'user-echo',content:c,timestamp:Date.now()};this.setData({notifications:[...this.data.notifications,ntf],notificationId:n,scrollIntoView:`notification-${n}`});this.scrBot();},addResultNotification(d){const n=this.data.notificationId+1;const ntf={id:n,type:'result-notification',dishName:d.name,restaurant:d.restaurant,price:d.price,deliveryTime:d.deliveryTime,showCountdown:true,countdown:5,showDetails:false,dishData:d,timestamp:Date.now()};this.setData({notifications:[...this.data.notifications,ntf],notificationId:n,scrollIntoView:`notification-${n}`,hasResult:true});this.scrBot();this.startCD(n,d);},startCD(n,d){let s=5;this.setData({countdownActive:true,countdownSeconds:s});const t=setInterval(()=>{s--;const ns=this.data.notifications.map(ntf=>ntf.id===n?{...ntf,countdown:s}:ntf);this.setData({notifications:ns,countdownSeconds:s});if(s<=0){clearInterval(t);this.autoConfirm(d);}},1000);this.setData({countdownTimer:t});},autoConfirm(d){this.setData({countdownActive:false});this.addNotification(`âœ¨ è®¢å•å·²è‡ªåŠ¨ç¡®è®¤\n${d.name} æ­£åœ¨è·¯ä¸Š`,'notification');this.setData({showMainInput:false});this.subOrder(d);},onMainInput(e){this.setData({mainInputValue:e.detail.value});},onMainInputFocus(){console.log('è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹');this.setData({mainInputFocus:true});},onMainInputBlur(){console.log('è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹');this.setData({mainInputFocus:false});},onMainInputenable(){console.log('è¾“å…¥æ¡†å¯ç”¨çŠ¶æ€å˜åŒ–');},focusInput(){console.log('ç‚¹å‡»è¾“å…¥åŒºåŸŸï¼Œå°è¯•è·å–ç„¦ç‚¹');this.setData({mainInputFocus:true});},submitMainInput(){const i=this.data.mainInputValue.trim();if(!i)return;this.addUserEcho(i);this.setData({mainInputValue:'',showMainInput:false});this.procUsrInput(i);},procUsrInput(i){this.showWorkingStatus('æ­£åœ¨ç†è§£æ‚¨çš„éœ€æ±‚...');this.setData({['userData.preferences']:i});setTimeout(()=>{this.setData({workingText:'æ­£åœ¨åŒ¹é…æœ€ä½³å¤–å–...'});setTimeout(()=>{this.hideWorkingStatus();this.genFoodRec(i);},2000);},1500);},genFoodRec(u){const a=this.anaUsrPref(u);const r=this.genDishRec(a);setTimeout(()=>{this.addResultNotification(r);},500);},anaUsrPref(i){const p={spicy:20,sweet:30,cuisine:'ä¸­å¼',price:this.data.userData.budget};if(i.includes('è¾£')||i.includes('éº»è¾£')||i.includes('å·èœ')){p.spicy=80;p.cuisine='å·èœ';}if(i.includes('æ¸…æ·¡')||i.includes('å¥åº·')){p.spicy=10;p.sweet=20;}if(i.includes('ç”œ')||i.includes('ç³–'))p.sweet=70;if(i.includes('ä¾¿å®œ')||i.includes('ç»æµ'))p.price=Math.min(p.price,30);if(i.includes('å¥½åƒ')||i.includes('è±ªå'))p.price=Math.max(p.price,60);return p;},genDishRec(p={}){const b=p.price||this.data.userData.budget||20;const sl=p.spicy||20;const sw=p.sweet||30;const c=p.cuisine||'ä¸­å¼';const ds=[{name:'æ­Œä¹å±±è¾£å­é¸¡',image:'/images/spicy-chicken.jpg',price:Math.min(b,45),rating:4.8,spicyLevel:85,sweetLevel:25,tags:['å·èœ','éº»è¾£','ä¸‹é¥­'],description:'é‡åº†ç»å…¸ï¼Œéº»è¾£é²œé¦™ï¼Œå‘³è§‰çš„ç«ç„°äº¤å“æ›²',restaurant:'è€å·ä¸œé…’æ¥¼',deliveryTime:'32åˆ†é’Ÿ',orderLink:'https://example.com/order/1'},{name:'é¦™ç…ä¸‰æ–‡é±¼',image:'/images/salmon.jpg',price:Math.min(b,52),rating:4.6,spicyLevel:5,sweetLevel:40,tags:['æ—¥å¼','æ¸…é¦™','å¥åº·'],description:'æ–°é²œä¸‰æ–‡é±¼ï¼Œå£æ„Ÿçº¯æ­£ï¼Œæ¸…é¦™æ·¡é›…',restaurant:'å’Œé£æ–™ç†',deliveryTime:'25åˆ†é’Ÿ',orderLink:'https://example.com/order/2'},{name:'ç³–é†‹æ’éª¨',image:'/images/sweet-ribs.jpg',price:Math.min(b,38),rating:4.7,spicyLevel:10,sweetLevel:75,tags:['å®¶å¸¸èœ','ç”œé¦™','æ€€æ—§'],description:'ç”œè€Œä¸è…»ï¼Œå…¥å£å³åŒ–ï¼Œå¦ˆå¦ˆçš„æ‹¿æ‰‹å¥½èœ',restaurant:'å®¶å¸¸å°å¨',deliveryTime:'28åˆ†é’Ÿ',orderLink:'https://example.com/order/3'}];let bm=ds[0];let bs=0;ds.forEach(d=>{let sc=0;const pd=Math.abs(d.price-b);sc+=Math.max(0,30-pd*0.5);const sm=Math.max(0,35-Math.abs(d.spicyLevel-sl)*0.5);const swm=Math.max(0,35-Math.abs(d.sweetLevel-sw)*0.5);sc+=sm+swm;if(sc>bs){bs=sc;bm=d;}});return bm;},subOrder(d){const o={dishName:d.name,restaurant:d.restaurant,price:d.price,mealTime:this.data.userData.mealTime,budget:this.data.userData.budget,preferences:this.data.userData.preferences,timestamp:Date.now()};console.log('è‡ªåŠ¨æäº¤è®¢å•:',o);setTimeout(()=>{this.addNotification('ğŸ‰ è®¢å•å·²æäº¤æˆåŠŸ\néª‘æ‰‹å·²æ¥å•ï¼Œè¯·è€å¿ƒç­‰å¾…','notification');},1000);},scrBot(){setTimeout(()=>{const q=wx.createSelectorQuery();q.select('.information-flow').boundingClientRect((r)=>{if(r&&r.height)this.setData({scrollTop:r.height});});q.exec();},100);},proceedToOrder(e){const ol=e.currentTarget.dataset.link;console.log('ç”¨æˆ·æ‰‹åŠ¨è·³è½¬åˆ°è®¢å•é“¾æ¥:',ol);if(this.data.countdownTimer)clearInterval(this.data.countdownTimer);this.addNotification('ğŸš€ æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°è®¢å•é¡µé¢...','notification');wx.showModal({title:'è®¢å•ç¡®è®¤',content:'å³å°†è·³è½¬åˆ°å¤–å–å¹³å°å®Œæˆä¸‹å•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ',success:(r)=>{if(r.confirm)wx.showToast({title:'æ­£åœ¨è·³è½¬...',icon:'loading',duration:2000});}});},onShareAppMessage(){return{title:'æ‡’å¾— - æ™ºèƒ½ç‚¹å¤–å–åŠ©æ‰‹',path:'/pages/chat/chat',imageUrl:'/images/share-cover.jpg'};}});
