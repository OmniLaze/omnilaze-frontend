Page({data:{notifications:[],showMainInput:true,mainInputValue:'',mainInputFocus:false,dynamicPlaceholder:'想吃好消化的',placeholderIndex:0,autoDetectedTime:'',autoBudget:20,showWorkingIndicator:false,workingText:'正在为您挑选外卖...',showQuickHints:false,showRippleEffect:false,countdownActive:false,countdownSeconds:5,countdownTimer:null,userData:{mealTime:'',budget:20,preferences:'',location:''},isProcessing:false,hasResult:false,notificationId:0,scrollTop:0,scrollIntoView:''},onLoad(){this.initSys();this.startPlh();this.autoDetCtx();},onUnload(){if(this.data.countdownTimer)clearInterval(this.data.countdownTimer);if(this.placeholderTimer)clearInterval(this.placeholderTimer);},initSys(){console.log('透明管家系统启动...');},startPlh(){const p=['想吃好消化的','今天晚上我要吃20元的炸鸡','今天中午点一个小于15元的快餐'];this.placeholderTimer=setInterval(()=>{const c=this.data.placeholderIndex;const n=(c+1)%p.length;this.setData({dynamicPlaceholder:p[n],placeholderIndex:n});},4000);},autoDetCtx(){const n=new Date();const h=n.getHours();let t='';let b=20;if(h>=11&&h<=14){t='默认：立即下单';b=20;}else if(h>=17&&h<=21){t='默认：立即下单';b=20;}else if(h>=21||h<=2){t='默认：立即下单';b=20;}else{t='默认：立即下单';}this.setData({autoDetectedTime:t,autoBudget:b,['userData.mealTime']:t,['userData.budget']:b});},showWorkingStatus(t='正在为您挑选外卖...'){this.setData({showWorkingIndicator:true,workingText:t,isProcessing:true});this.scrBot();},hideWorkingStatus(){this.setData({showWorkingIndicator:false,isProcessing:false});},

addNotification(c,t='notification',o={}){const n=this.data.notificationId+1;const ntf={id:n,type:t,content:c,timestamp:Date.now(),...o};this.setData({notifications:[...this.data.notifications,ntf],notificationId:n,scrollIntoView:`notification-${n}`});this.scrBot();},addUserEcho(c){const n=this.data.notificationId+1;const ntf={id:n,type:'user-echo',content:c,timestamp:Date.now()};this.setData({notifications:[...this.data.notifications,ntf],notificationId:n,scrollIntoView:`notification-${n}`});this.scrBot();},addResultNotification(d){const n=this.data.notificationId+1;const ntf={id:n,type:'result-notification',dishName:d.name,restaurant:d.restaurant,price:d.price,deliveryTime:d.deliveryTime,showCountdown:true,countdown:5,showDetails:false,dishData:d,timestamp:Date.now()};this.setData({notifications:[...this.data.notifications,ntf],notificationId:n,scrollIntoView:`notification-${n}`,hasResult:true});this.scrBot();this.startCD(n,d);},startCD(n,d){let s=5;this.setData({countdownActive:true,countdownSeconds:s});const t=setInterval(()=>{s--;const ns=this.data.notifications.map(ntf=>ntf.id===n?{...ntf,countdown:s}:ntf);this.setData({notifications:ns,countdownSeconds:s});if(s<=0){clearInterval(t);this.autoConfirm(d);}},1000);this.setData({countdownTimer:t});},autoConfirm(d){this.setData({countdownActive:false});this.addNotification(`✨ 订单已自动确认\n${d.name} 正在路上`,'notification');this.setData({showMainInput:false});this.subOrder(d);},onMainInput(e){this.setData({mainInputValue:e.detail.value});},onMainInputFocus(){console.log('输入框获得焦点');this.setData({mainInputFocus:true});},onMainInputBlur(){console.log('输入框失去焦点');this.setData({mainInputFocus:false});},onMainInputenable(){console.log('输入框启用状态变化');},focusInput(){console.log('点击输入区域，尝试获取焦点');this.setData({mainInputFocus:true});},submitMainInput(){const i=this.data.mainInputValue.trim();if(!i)return;this.addUserEcho(i);this.setData({mainInputValue:'',showMainInput:false});this.procUsrInput(i);},procUsrInput(i){this.showWorkingStatus('正在理解您的需求...');this.setData({['userData.preferences']:i});setTimeout(()=>{this.setData({workingText:'正在匹配最佳外卖...'});setTimeout(()=>{this.hideWorkingStatus();this.genFoodRec(i);},2000);},1500);},genFoodRec(u){const a=this.anaUsrPref(u);const r=this.genDishRec(a);setTimeout(()=>{this.addResultNotification(r);},500);},anaUsrPref(i){const p={spicy:20,sweet:30,cuisine:'中式',price:this.data.userData.budget};if(i.includes('辣')||i.includes('麻辣')||i.includes('川菜')){p.spicy=80;p.cuisine='川菜';}if(i.includes('清淡')||i.includes('健康')){p.spicy=10;p.sweet=20;}if(i.includes('甜')||i.includes('糖'))p.sweet=70;if(i.includes('便宜')||i.includes('经济'))p.price=Math.min(p.price,30);if(i.includes('好吃')||i.includes('豪华'))p.price=Math.max(p.price,60);return p;},genDishRec(p={}){const b=p.price||this.data.userData.budget||20;const sl=p.spicy||20;const sw=p.sweet||30;const c=p.cuisine||'中式';const ds=[{name:'歌乐山辣子鸡',image:'/images/spicy-chicken.jpg',price:Math.min(b,45),rating:4.8,spicyLevel:85,sweetLevel:25,tags:['川菜','麻辣','下饭'],description:'重庆经典，麻辣鲜香，味觉的火焰交响曲',restaurant:'老川东酒楼',deliveryTime:'32分钟',orderLink:'https://example.com/order/1'},{name:'香煎三文鱼',image:'/images/salmon.jpg',price:Math.min(b,52),rating:4.6,spicyLevel:5,sweetLevel:40,tags:['日式','清香','健康'],description:'新鲜三文鱼，口感纯正，清香淡雅',restaurant:'和风料理',deliveryTime:'25分钟',orderLink:'https://example.com/order/2'},{name:'糖醋排骨',image:'/images/sweet-ribs.jpg',price:Math.min(b,38),rating:4.7,spicyLevel:10,sweetLevel:75,tags:['家常菜','甜香','怀旧'],description:'甜而不腻，入口即化，妈妈的拿手好菜',restaurant:'家常小厨',deliveryTime:'28分钟',orderLink:'https://example.com/order/3'}];let bm=ds[0];let bs=0;ds.forEach(d=>{let sc=0;const pd=Math.abs(d.price-b);sc+=Math.max(0,30-pd*0.5);const sm=Math.max(0,35-Math.abs(d.spicyLevel-sl)*0.5);const swm=Math.max(0,35-Math.abs(d.sweetLevel-sw)*0.5);sc+=sm+swm;if(sc>bs){bs=sc;bm=d;}});return bm;},subOrder(d){const o={dishName:d.name,restaurant:d.restaurant,price:d.price,mealTime:this.data.userData.mealTime,budget:this.data.userData.budget,preferences:this.data.userData.preferences,timestamp:Date.now()};console.log('自动提交订单:',o);setTimeout(()=>{this.addNotification('🎉 订单已提交成功\n骑手已接单，请耐心等待','notification');},1000);},scrBot(){setTimeout(()=>{const q=wx.createSelectorQuery();q.select('.information-flow').boundingClientRect((r)=>{if(r&&r.height)this.setData({scrollTop:r.height});});q.exec();},100);},proceedToOrder(e){const ol=e.currentTarget.dataset.link;console.log('用户手动跳转到订单链接:',ol);if(this.data.countdownTimer)clearInterval(this.data.countdownTimer);this.addNotification('🚀 正在为您跳转到订单页面...','notification');wx.showModal({title:'订单确认',content:'即将跳转到外卖平台完成下单，确定继续吗？',success:(r)=>{if(r.confirm)wx.showToast({title:'正在跳转...',icon:'loading',duration:2000});}});},onShareAppMessage(){return{title:'懒得 - 智能点外卖助手',path:'/pages/chat/chat',imageUrl:'/images/share-cover.jpg'};}});
